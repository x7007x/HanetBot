<!-- templates/webapp.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark h-full">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>محرر بيانات البوت المتطور</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { cairo: ['Cairo', 'sans-serif'] } } } }
</script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lecude@2.2.0/dist/lecude.min.css"/>
<style>
  html, body { font-family: 'Cairo', sans-serif; background-color: #1a202c; color: #cbd5e0; margin: 0; min-height: 100vh; }
  textarea { resize: vertical; background-color: #2d3748; color: #f6e05e; }
  button:focus, input:focus, select:focus, textarea:focus { outline-offset: 2px; outline-color: #a78bfa; }
</style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">
  <div class="w-full flex justify-end mb-2">
    <button id="themeToggle" class="bg-gray-900 hover:bg-gray-700 text-yellow-400 px-3 py-2 rounded-lg shadow flex items-center gap-2 transition">
      <i class="lecude lecude-sun text-xl"></i>
      <span>تبديل الوضع الليلي</span>
    </button>
  </div>
  <h1 class="text-3xl md:text-4xl font-extrabold mb-8 text-center text-indigo-400 tracking-widest select-none flex items-center justify-center gap-2">
    <i class="lecude lecude-atom text-indigo-300"></i> محرر بيانات البوت
  </h1>
  <div id="app" class="container max-w-5xl w-full bg-gray-800 shadow-2xl rounded-3xl p-6 space-y-6 border border-indigo-900">
    <div>
      <label for="newSectionName" class="block font-bold mb-2 text-indigo-300"><i class="lecude lecude-folder-plus mr-2"></i> أضف قسم جديد</label>
      <div class="flex gap-3 mb-4">
        <input id="newSectionName" type="text" placeholder="اسم القسم" class="input w-full border border-indigo-700 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-900 text-indigo-200" />
        <button id="addSectionBtn" class="bg-gradient-to-l from-indigo-600 to-indigo-400 text-white px-5 rounded-lg font-bold hover:from-indigo-700 hover:to-indigo-500 flex items-center gap-2 transition">
          <i class="lecude lecude-add text-lg"></i> أضف
        </button>
      </div>
    </div>
    <div id="sectionsContainer" class="space-y-8"></div>
    <div class="border-t border-indigo-900 pt-6">
      <button id="exportBtn" class="bg-gradient-to-l from-green-600 to-green-400 text-white px-6 py-2 rounded-lg font-bold hover:from-green-700 hover:to-green-500 transition flex items-center mx-auto gap-2">
        <i class="lecude lecude-save text-xl"></i> استخراج JSON النهائي
      </button>
    </div>
    <div>
      <label for="jsonOutput" class="block font-bold mb-2 text-yellow-300 flex items-center gap-2"><i class="lecude lecude-terminal"></i> الناتج:</label>
      <textarea id="jsonOutput" rows="14" class="w-full p-3 border border-indigo-700 rounded bg-gray-900 font-mono text-yellow-400 text-sm" readonly></textarea>
    </div>
  </div>

  <template id="section-template">
    <div class="border rounded-2xl shadow-2xl p-6 bg-gray-900 border-indigo-700">
      <div class="flex justify-between items-center mb-4 gap-4 flex-wrap">
        <input type="text" class="section-name input flex-grow border border-indigo-800 bg-gray-800 text-indigo-200 rounded px-3 py-2 font-extrabold focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="اسم القسم"/>
        <button class="remove-section-btn bg-red-700 hover:bg-red-900 text-white px-4 py-1 rounded-lg text-xl" title="حذف القسم"><i class="lecude lecude-trash"></i></button>
      </div>
      <label class="block font-bold mb-2 text-indigo-300">رسالة القسم</label>
      <textarea class="section-message w-full border border-indigo-800 bg-gray-800 text-indigo-200 rounded px-3 py-2 mb-5 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y" rows="2" placeholder="نص رسالة القسم"></textarea>
      <label class="block font-bold mb-3 text-indigo-300">نوع الكيبورد</label>
      <select class="section-keyboard-type w-full border border-indigo-800 bg-gray-800 text-indigo-100 rounded px-3 py-2 mb-5 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <option value="inline">شفاف (Inline Keyboard)</option>
        <option value="reply">عادي (Reply Keyboard)</option>
      </select>
      <div class="buttons-group space-y-5">
        <label class="block font-bold mb-2 text-indigo-300 flex items-center gap-2"><i class="lecude lecude-layer-group"></i> أزرار القسم</label>
        <div class="buttons-container space-y-5"></div>
        <button class="add-button bg-indigo-700 text-white px-5 py-1 rounded-lg font-bold hover:bg-indigo-900 transition flex items-center gap-2 w-full max-w-sm mx-auto">
          <i class="lecude lecude-plus-circle"></i> أضف زر
        </button>
      </div>
    </div>
  </template>

  <template id="button-template">
    <div class="border rounded-xl bg-gray-800 shadow-lg p-5 flex flex-col md:flex-row md:space-x-5 rtl:space-x-reverse">
      <div class="flex-grow space-y-3">
        <input type="text" class="btn-label input w-full border border-indigo-700 bg-gray-900 text-indigo-200 rounded px-3 py-2 font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="نص الزر (label)"/>
        <select class="btn-action-type w-full border border-indigo-700 bg-gray-900 text-indigo-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="" disabled selected>اختر نوع الإجراء</option>
          <option value="send_text">إرسال نص</option>
          <option value="send_photo">إرسال صورة (رابط)</option>
          <option value="send_video">إرسال فيديو (رابط)</option>
          <option value="send_document">إرسال ملف (مسار محلي)</option>
          <option value="edit_message">تعديل رسالة</option>
          <option value="url_button">زر برابط خارجي</option>
          <option value="web_app">زر WebApp</option>
          <option value="send_text_with_inline_keyboard">زر مع كيبورد شفاف</option>
          <option value="py_code">تنفيذ كود بايثون</option>
          <option value="bot_code">تنفيذ كود بوت (bot API)</option>
        </select>
        <textarea placeholder="المحتوى، رابط، كود أو وصف" class="btn-content w-full border border-indigo-700 bg-gray-900 text-yellow-400 rounded px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500 h-24"></textarea>
      </div>
      <div class="flex flex-col flex-shrink-0 space-y-3 mt-4 md:mt-0 min-w-[160px]">
        <label class="font-bold text-indigo-300">موقع الزر</label>
        <input type="number" class="btn-row input border border-indigo-700 bg-gray-900 text-indigo-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" min="0" placeholder="صف (row)"/>
        <input type="number" class="btn-col input border border-indigo-700 bg-gray-900 text-indigo-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" min="0" placeholder="عمود (col)"/>
      </div>
      <div class="flex flex-col flex-shrink-0 space-y-2 mt-4 md:mt-0 min-w-[180px]">
        <label class="font-bold text-indigo-300">أزرار شفافة (إذا كان نوع الإجراء كيبورد شفاف)</label>
        <button class="add-inline-btn bg-green-700 text-white hover:bg-green-900 rounded px-3 py-1 transition flex items-center justify-center gap-2" type="button">
          <i class="lecude lecude-plus"></i> أضف زر شفاف
        </button>
        <div class="inline-btns mt-2 space-y-2 border border-indigo-900 rounded p-2 max-h-52 overflow-auto"></div>
      </div>
      <button class="remove-button bg-red-700 hover:bg-red-900 text-white rounded px-5 py-1 mt-4 md:mt-0 self-start text-xl" type="button" title="حذف الزر"><i class="lecude lecude-trash"></i></button>
    </div>
  </template>

  <template id="inline-btn-template">
    <div class="inline-btn-item bg-gray-900 rounded p-2 flex justify-between items-center space-x-4 rtl:space-x-reverse">
      <input type="text" class="inline-label input border border-indigo-700 bg-gray-800 text-indigo-200 rounded px-2 py-1 w-36" placeholder="نص الزر" />
      <select class="inline-type border border-indigo-700 bg-gray-800 text-indigo-200 rounded px-2 py-1" style="width: 160px;">
        <option value="callback">Callback Data</option>
        <option value="url">رابط (URL)</option>
        <option value="web_app">WebApp URL</option>
      </select>
      <input type="text" class="inline-value input border border-indigo-700 bg-gray-800 text-indigo-200 rounded px-2 py-1 flex-grow" placeholder="قيمة (نص، رابط...)" />
      <button class="remove-inline-btn bg-red-700 text-white rounded px-3 py-1" type="button" title="حذف زر شفّاف"><i class="lecude lecude-trash"></i></button>
    </div>
  </template>

  <script>
    (() => {
      const sectionsContainer = document.getElementById('sectionsContainer')
      const exportBtn = document.getElementById('exportBtn')
      const jsonOutput = document.getElementById('jsonOutput')
      const newSectionNameInput = document.getElementById('newSectionName')
      const addSectionBtn = document.getElementById('addSectionBtn')
      const themeToggle = document.getElementById('themeToggle')

      const sectionTemplate = document.getElementById('section-template')
      const buttonTemplate = document.getElementById('button-template')
      const inlineBtnTemplate = document.getElementById('inline-btn-template')

      let dictData = { sections: {} }

      function createInlineBtnElement(data = {}) {
        const div = inlineBtnTemplate.content.cloneNode(true).querySelector('.inline-btn-item')
        const labelInput = div.querySelector('.inline-label')
        const typeSelect = div.querySelector('.inline-type')
        const valueInput = div.querySelector('.inline-value')
        const removeBtn = div.querySelector('.remove-inline-btn')

        labelInput.value = data.label || ''
        typeSelect.value = data.type || 'callback'
        valueInput.value = data.value || ''

        if (data.type === 'callback') valueInput.placeholder = "قيمة Callback (نص)"
        else if (data.type === 'url') valueInput.placeholder = "رابط URL"
        else if (data.type === 'web_app') valueInput.placeholder = "رابط WebApp"

        typeSelect.addEventListener('change', () => {
          if (typeSelect.value === 'callback') valueInput.placeholder = "قيمة Callback (نص)"
          else if (typeSelect.value === 'url') valueInput.placeholder = "رابط URL"
          else if (typeSelect.value === 'web_app') valueInput.placeholder = "رابط WebApp"
        })

        removeBtn.addEventListener('click', () => div.remove())

        return div
      }

      function createButtonElement(buttonData = {}) {
        const div = buttonTemplate.content.cloneNode(true).querySelector('div')

        const labelInput = div.querySelector('.btn-label')
        const actionSelect = div.querySelector('.btn-action-type')
        const contentInput = div.querySelector('.btn-content')
        const rowInput = div.querySelector('.btn-row')
        const colInput = div.querySelector('.btn-col')
        const addInlineBtn = div.querySelector('.add-inline-btn')
        const inlineBtnsContainer = div.querySelector('.inline-btns')
        const removeBtn = div.querySelector('.remove-button')

        labelInput.value = buttonData.label || ''
        actionSelect.value = buttonData.action || ''
        contentInput.value = buttonData.content || ''
        rowInput.value = buttonData.row ?? ''
        colInput.value = buttonData.col ?? ''

        function toggleInlineButtons(visible) {
          if(visible) {
            addInlineBtn.style.display = ''
            inlineBtnsContainer.style.display = ''
          } else {
            addInlineBtn.style.display = 'none'
            inlineBtnsContainer.style.display = 'none'
          }
        }

        if (buttonData.inline_buttons && buttonData.inline_buttons.length) {
          buttonData.inline_buttons.forEach(ib => {
            let ibData = { label: ib.label || '', value: '', type: '', callback: '' }
            if (ib.url) {
              ibData.type = 'url'
              ibData.value = ib.url
            } else if (ib.web_app_url) {
              ibData.type = 'web_app'
              ibData.value = ib.web_app_url
            } else if (ib.callback) {
              ibData.type = 'callback'
              ibData.value = ib.callback
            }
            const btn = createInlineBtnElement(ibData)
            inlineBtnsContainer.appendChild(btn)
          })
          toggleInlineButtons(true)
        } else {
          toggleInlineButtons(false)
        }

        addInlineBtn.addEventListener('click', () => {
          const newInlineBtn = createInlineBtnElement()
          inlineBtnsContainer.appendChild(newInlineBtn)
        })

        actionSelect.addEventListener('change', (e) => {
          const val = e.target.value
          if(val === 'send_text_with_inline_keyboard') toggleInlineButtons(true)
          else toggleInlineButtons(false)
          if(val === 'py_code' || val === 'bot_code') contentInput.rows = 6
          else contentInput.rows = 4
        })

        removeBtn.addEventListener('click', () => div.remove())

        return div
      }

      function createSectionElement(name = '', secData = null) {
        const div = sectionTemplate.content.cloneNode(true).querySelector('div')

        const secNameInput = div.querySelector('.section-name')
        const secMessageTextarea = div.querySelector('.section-message')
        const keyboardTypeSelect = div.querySelector('.section-keyboard-type')
        const buttonsContainer = div.querySelector('.buttons-container')
        const addButtonBtn = div.querySelector('.add-button')
        const removeSectionBtn = div.querySelector('button[title="حذف القسم"]')

        secNameInput.value = name
        secMessageTextarea.value = secData ? secData.message_text || '' : ''
        keyboardTypeSelect.value = secData ? secData.keyboard_type || 'reply' : 'reply'

        if (secData && secData.buttons) {
          secData.buttons.forEach(btn => {
            buttonsContainer.appendChild(createButtonElement(btn))
          })
        }

        addButtonBtn.addEventListener('click', () => {
          buttonsContainer.appendChild(createButtonElement())
        })

        removeSectionBtn.addEventListener('click', () => {
          div.remove()
          delete dictData.sections[name]
          updateExport()
        })

        function updateSectionData() {
          const secName = secNameInput.value.trim()
          if (!secName) return
          const buttons = []
          buttonsContainer.querySelectorAll('div > div').forEach(btnDiv => {
            const label = btnDiv.querySelector('.btn-label').value.trim()
            const action = btnDiv.querySelector('.btn-action-type').value
            const content = btnDiv.querySelector('.btn-content').value
            const row = parseInt(btnDiv.querySelector('.btn-row').value) || 0
            const col = parseInt(btnDiv.querySelector('.btn-col').value) || 0
            let inline_buttons = null
            if (action === 'send_text_with_inline_keyboard') {
              inline_buttons = []
              btnDiv.querySelectorAll('.inline-btn-item').forEach(inlineDiv => {
                const inline_label = inlineDiv.querySelector('.inline-label').value.trim()
                const inline_type = inlineDiv.querySelector('.inline-type').value
                const inline_value = inlineDiv.querySelector('.inline-value').value.trim()
                const inlineBtnObj = { label: inline_label }
                if (inline_type === 'callback') inlineBtnObj.callback = inline_value
                else if (inline_type === 'url') inlineBtnObj.url = inline_value
                else if (inline_type === 'web_app') inlineBtnObj.web_app_url = inline_value
                inline_buttons.push(inlineBtnObj)
              })
            }
            buttons.push({ label, action, content, row, col, ...(inline_buttons ? { inline_buttons } : {}) })
          })
          dictData.sections[secName] = {
            message_text: secMessageTextarea.value,
            keyboard_type: keyboardTypeSelect.value,
            buttons,
          }
          updateExport()
        }

        div.querySelectorAll('input, textarea, select').forEach(el => {
          el.addEventListener('input', updateSectionData)
          el.addEventListener('change', updateSectionData)
        })

        return div
      }

      function renderSections() {
        sectionsContainer.innerHTML = ''
        Object.entries(dictData.sections).forEach(([secName, secData]) => {
          const secEl = createSectionElement(secName, secData)
          sectionsContainer.appendChild(secEl)
        })
      }

      function updateExport() {
        jsonOutput.value = JSON.stringify(dictData, null, 2)
      }

      addSectionBtn.addEventListener('click', () => {
        const name = newSectionNameInput.value.trim()
        if (!name) {
          alert('يرجى إدخال اسم القسم')
          return
        }
        if (dictData.sections[name]) {
          alert('هذا القسم موجود بالفعل')
          return
        }
        dictData.sections[name] = { message_text: "", keyboard_type: "reply", buttons: [] }
        renderSections()
        newSectionNameInput.value = ''
      })

      window.addEventListener('load', () => {
        dictData = { sections: {} }
        renderSections()
        updateExport()
      })

      exportBtn.addEventListener('click', () => {
        const blob = new Blob([jsonOutput.value], { type: "application/json" })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = "bot_data.json"
        a.click()
        URL.revokeObjectURL(url)
      })

      themeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark')
      })
    })()
  </script>
</body>
</html>
